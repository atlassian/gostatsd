FROM golang:1.17.2-buster AS build
# Keep golang version in sync with MakeFile, .travis.yml, Dockerfile-multiarch and README.md
WORKDIR /build

# Install dependencies first to take advantage of the docker build cache.
ADD go.mod /build/go.mod
ADD go.sum /build/go.sum

RUN go mod download

ARG TARGETARCH
ARG BINARY_NAME
ARG MAIN_PKG
ARG REPO_VERSION
ARG GIT_HASH
ARG BUILD_DATE

ADD . /build

RUN apt-get update && apt-get install git

RUN FLAGS="-s -X main.Version=${REPO_VERSION} -X main.GitCommit=${GIT_HASH} -X main.BuildDate=${BUILD_DATE}" \
    GOOS=linux GOARCH=${TARGETARCH} go build -race -o bin/linux/${TARGETARCH}/${BINARY_NAME} -ldflags "${FLAGS}" ${MAIN_PKG}

FROM ubuntu:18.04

RUN export DEBIAN_FRONTEND=noninteractive && \
    apt-get update && \
    apt-get install ca-certificates -y && \
    rm -rf /var/lib/apt/lists/*

ARG TARGETARCH
COPY --from=build /build/bin/linux/${TARGETARCH}/gostatsd /bin/gostatsd

ENTRYPOINT ["gostatsd"]
