# Go version needs to be the same in: CI config, README, Dockerfiles, and Makefile
FROM golang:1.20.6-alpine AS build
WORKDIR /build

# Install dependencies first to take advantage of the docker build cache.
ADD go.mod /build/go.mod
ADD go.sum /build/go.sum

RUN go mod download

ARG TARGETARCH
ARG BINARY_NAME
ARG MAIN_PKG

ADD . /build

# We need git, gcc, libc-dev
RUN apk update && apk add --update git gcc libc-dev

# Race needs CGO
# https://github.com/golang/go/issues/51235
RUN ldFlags="-s -X main.Version=$(git describe --abbrev=0 --tags) -X main.GitCommit=$(git rev-parse --short HEAD) -X main.BuildDate=$(date +%Y-%m-%d-%H:%M)"; \
    CGO_ENABLED=1 GOOS=linux GOARCH=${TARGETARCH} go build -race -o bin/linux/${TARGETARCH}/${BINARY_NAME} -ldflags "${ldFlags}" ${MAIN_PKG}

FROM ubuntu:18.04

RUN export DEBIAN_FRONTEND=noninteractive && \
    apt-get update && \
    apt-get install ca-certificates -y && \
    rm -rf /var/lib/apt/lists/*

ARG TARGETARCH
COPY --from=build /build/bin/linux/${TARGETARCH}/gostatsd /bin/gostatsd

ENTRYPOINT ["gostatsd"]
